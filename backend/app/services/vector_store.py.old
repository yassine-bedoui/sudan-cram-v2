from qdrant_client import QdrantClient
from qdrant_client.models import Distance, VectorParams, PointStruct
from sentence_transformers import SentenceTransformer
import os
from typing import List, Dict
from dotenv import load_dotenv

load_dotenv()

class VectorStore:
    def __init__(self):
        print("ðŸ”§ Initializing Vector Store...")
        
        # Connect to Qdrant Cloud
        self.client = QdrantClient(
            url=os.getenv("QDRANT_URL"),
            api_key=os.getenv("QDRANT_API_KEY"),
            timeout=60
        )
        
        self.collection_name = "sudan_events"
        
        # Load multilingual embedding model
        print("ðŸ“¦ Loading embedding model...")
        self.encoder = SentenceTransformer('Alibaba-NLP/gte-multilingual-base', trust_remote_code=True)
        print("âœ… Embedding model loaded")
        
        self._init_collection()
    
    def _init_collection(self):
        """Initialize Qdrant collection"""
        try:
            collections = self.client.get_collections().collections
            exists = any(c.name == self.collection_name for c in collections)
            
            if not exists:
                self.client.create_collection(
                    collection_name=self.collection_name,
                    vectors_config=VectorParams(size=768, distance=Distance.COSINE)
                )
                print(f"âœ… Created collection: {self.collection_name}")
            else:
                print(f"âœ… Collection exists: {self.collection_name}")
        
        except Exception as e:
            print(f"âŒ Error: {e}")
            raise
    
    def add_event(self, event_id: str, text: str, metadata: Dict) -> bool:
        """Add event to vector store"""
        try:
            embedding = self.encoder.encode(text).tolist()
            
            self.client.upsert(
                collection_name=self.collection_name,
                points=[PointStruct(id=event_id, vector=embedding, payload=metadata)]
            )
            return True
        except Exception as e:
            print(f"âŒ Error adding {event_id}: {e}")
            return False
    
    def semantic_search(self, query: str, filters: Dict = None, top_k: int = 10) -> List[Dict]:
        """Search for relevant events"""
        try:
            query_embedding = self.encoder.encode(query).tolist()
            
            qdrant_filter = None
            if filters:
                conditions = [{"key": k, "match": {"value": v}} for k, v in filters.items()]
                qdrant_filter = {"must": conditions} if conditions else None
            
            results = self.client.search(
                collection_name=self.collection_name,
                query_vector=query_embedding,
                limit=top_k,
                query_filter=qdrant_filter,
                with_payload=True
            )
            
            return [{"id": r.id, "score": r.score, "metadata": r.payload} for r in results]
        
        except Exception as e:
            print(f"âŒ Search error: {e}")
            return []
    
    def get_event_count(self) -> int:
        """Get total events"""
        try:
            info = self.client.get_collection(self.collection_name)
            return info.points_count
        except:
            return 0
