from datetime import datetime

from langgraph.graph import StateGraph, END

from app.agents.state import SudanCRAMState
from app.agents.langgraph_agents import (
    rag_retrieval_node,
    event_extractor_node,
    trend_analyst_node,
    scenario_generator_node,
    consistency_checker_node,
    human_approval_node,
    should_request_human_input,
)


# Build graph
workflow = StateGraph(SudanCRAMState)

# Register nodes
workflow.add_node("rag_retrieval", rag_retrieval_node)
workflow.add_node("event_extractor", event_extractor_node)
workflow.add_node("trend_analyst", trend_analyst_node)
workflow.add_node("scenario_generator", scenario_generator_node)
workflow.add_node("consistency_checker", consistency_checker_node)
workflow.add_node("human_approval", human_approval_node)

# Define flow
workflow.set_entry_point("rag_retrieval")
workflow.add_edge("rag_retrieval", "event_extractor")
workflow.add_edge("event_extractor", "trend_analyst")
workflow.add_edge("trend_analyst", "scenario_generator")
workflow.add_edge("scenario_generator", "consistency_checker")
workflow.add_edge("consistency_checker", "human_approval")

# Conditional edge from human_approval to END
workflow.add_conditional_edges(
    "human_approval",
    should_request_human_input,
    {
        "request_approval": END,
        "finalize": END,
    },
)

# Compile graph into an app
app = workflow.compile()


def run_analysis(
    region: str,
    raw_data: str | None = None,
    interventions: list[str] | None = None,
) -> SudanCRAMState:
    """Convenience function used by FastAPI router."""

    print("\n" + "=" * 60)
    print(f"ðŸš€ LANGGRAPH WORKFLOW START: {region}")
    print("=" * 60)

    initial_state: SudanCRAMState = {
        "region": region,
        "raw_data": raw_data,
        "interventions": interventions,
        "retrieved_events": [],
        "extracted_events": None,
        "trend_analysis": None,
        "scenarios": None,
        "validation": None,
        "human_approval_required": False,
        "approval_status": None,
        "messages": [],
        "confidence_score": 0.0,
        "timestamp": datetime.now().isoformat(),
    }

    result: SudanCRAMState = app.invoke(initial_state)

    print("\n" + "=" * 60)
    print("âœ… WORKFLOW COMPLETE")
    print("=" * 60)

    return result
